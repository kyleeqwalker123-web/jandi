<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>J & I Secure Chat</title>
    <style>
        body { font-family: -apple-system, sans-serif; background: #000; color: white; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        #setup { position: fixed; inset: 0; background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; }
        #chat { display: none; flex-direction: column; height: 100vh; }
        
        /* Mood & Buzz Header */
        .top-bar { background: #111; padding: 10px; border-bottom: 1px solid #333; display: flex; align-items: center; justify-content: space-between; }
        .mood-display { font-size: 24px; margin-right: 10px; }
        .mood-options span { cursor: pointer; margin: 0 5px; font-size: 20px; transition: 0.2s; }
        .mood-options span:hover { transform: scale(1.3); }
        .buzz-btn { background: #ff4757; color: white; border: none; padding: 5px 12px; border-radius: 5px; font-weight: bold; cursor: pointer; }

        /* Shake Animation */
        .shake { animation: shake 0.5s; background-color: #400 !important; }
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            100% { transform: translate(1px, 1px) rotate(0deg); }
        }

        #messages { flex-grow: 1; overflow-y: auto; list-style: none; padding: 20px; margin: 0; display: flex; flex-direction: column; }
        .msg { padding: 10px 15px; border-radius: 18px; margin: 5px 0; max-width: 75%; word-wrap: break-word; }
        .my-msg { background: #007bff; align-self: flex-end; }
        .their-msg { background: #333; align-self: flex-start; }
        
        .input-area { display: flex; background: #111; padding: 15px; border-top: 1px solid #222; }
        #input { flex-grow: 1; background: #222; color: white; border: none; padding: 12px; border-radius: 8px; margin-right: 10px; }
        .send-btn { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; }
    </style>
</head>
<body id="mainBody">

    <div id="setup">
        <h2>J & I Secure</h2>
        <select id="userSelect" style="padding:10px; margin-bottom:10px;"><option value="J">I am J</option><option value="I">I am I</option></select>
        <input type="text" id="roomInput" placeholder="Room Name" style="padding:10px; margin-bottom:10px;">
        <input type="password" id="passInput" placeholder="Password" style="padding:10px; margin-bottom:10px;">
        <button onclick="join()" style="width:200px; background:#007bff; color:white; padding:10px; border-radius:5px; border:none; font-weight:bold;">Enter Chat</button>
    </div>

    <div id="chat">
        <div class="top-bar">
            <div style="display: flex; align-items: center;">
                <div id="currentMood" class="mood-display">ðŸ˜Š</div>
                <div class="mood-options">
                    <span onclick="setMood('ðŸ˜Š')">ðŸ˜Š</span>
                    <span onclick="setMood('ðŸ˜´')">ðŸ˜´</span>
                    <span onclick="setMood('ðŸ”¥')">ðŸ”¥</span>
                    <span onclick="setMood('ðŸ’©')">ðŸ’©</span>
                    <span onclick="setMood('âœ¨')">âœ¨</span>
                </div>
            </div>
            <button class="buzz-btn" onclick="sendBuzz()">BUZZ âš¡</button>
        </div>

        <ul id="messages"></ul>
        <form id="form" class="input-area">
            <input id="input" autocomplete="off" placeholder="Message..."><button class="send-btn">Send</button>
        </form>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        const socket = io(); 
        let currentRoom = "", myLabel = "";

        function join() {
            const r = document.getElementById('roomInput').value;
            const p = document.getElementById('passInput').value;
            myLabel = document.getElementById('userSelect').value;
            if (r && p) {
                currentRoom = r + "_" + p;
                document.getElementById('setup').style.display = 'none';
                document.getElementById('chat').style.display = 'flex';
                socket.emit('join room', currentRoom);
            }
        }

        // MOOD & BUZZ LOGIC
        function setMood(m) { socket.emit('change mood', { room: currentRoom, mood: m }); }
        function sendBuzz() { socket.emit('send buzz', currentRoom); }

        socket.on('update mood', (m) => { document.getElementById('currentMood').innerText = m; });
        
        socket.on('get buzzed', () => {
            const body = document.getElementById('mainBody');
            body.classList.add('shake');
            setTimeout(() => body.classList.remove('shake'), 500);
            // Optional: play a small sound if you want later
        });

        // STANDARD CHAT LOGIC
        document.getElementById('form').onsubmit = (e) => {
            e.preventDefault();
            const input = document.getElementById('input');
            if (input.value) {
                socket.emit('chat message', { room: currentRoom, msg: input.value, user: myLabel });
                input.value = '';
            }
        };

        socket.on('chat message', (data) => {
            const item = document.createElement('li');
            item.className = data.user === myLabel ? 'msg my-msg' : 'msg their-msg';
            item.innerHTML = `<span style="font-size:10px; opacity:0.5; display:block;">${data.user}</span>${data.msg}`;
            document.getElementById('messages').appendChild(item);
            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
        });

        socket.on('load history', (h) => {
            document.getElementById('messages').innerHTML = '';
            h.forEach(msg => {
                const item = document.createElement('li');
                item.className = msg.user === myLabel ? 'msg my-msg' : 'msg their-msg';
                item.innerHTML = `<span style="font-size:10px; opacity:0.5; display:block;">${msg.user}</span>${msg.msg}`;
                document.getElementById('messages').appendChild(item);
            });
            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
        });
    </script>
</body>
</html>
