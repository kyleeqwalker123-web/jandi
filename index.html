<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>J & I Hub</title>
    <style>
        :root { --accent: #ff758c; --glass: rgba(255, 255, 255, 0.12); --bg-url: url('https://images.unsplash.com/photo-1464802686167-b939a67e06a1?q=80&w=2000'); }
        body.theme-midnight { --bg-url: url('https://images.unsplash.com/photo-1516339901600-2e1a62dc0c45?q=80&w=2000'); --accent: #7afcff; }
        body.theme-sunset { --bg-url: url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?q=80&w=2000'); --accent: #ff9e7d; }
        body.theme-forest { --bg-url: url('https://images.unsplash.com/photo-1441974231531-c6227db76b6e?q=80&w=2000'); --accent: #9dffb0; }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { 
            font-family: -apple-system, system-ui, sans-serif; background: #000; color: white; margin: 0; 
            height: 100dvh; overflow: hidden;
            background-image: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), var(--bg-url);
            background-size: cover; background-position: center; transition: background 1s ease;
        }

        /* Vertical Setup UI */
        #setup { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; padding: 20px; text-align: center; }
        .setup-card { width: 100%; max-width: 320px; background: rgba(255,255,255,0.08); backdrop-filter: blur(20px); padding: 25px; border-radius: 25px; border: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; gap: 15px; }
        .setup-input { width: 100%; padding: 15px; background: rgba(0,0,0,0.3); color: white; border: 1px solid rgba(255,255,255,0.1); border-radius: 15px; font-size: 16px; }
        .join-btn { width: 100%; padding: 16px; background: var(--accent); color: white; border: none; border-radius: 15px; font-size: 18px; font-weight: 600; }

        /* Doodle Modal */
        #canvas-container { display: none; position: fixed; inset: 0; background: #fff; z-index: 2000; flex-direction: column; }
        canvas { flex: 1; touch-action: none; background: #fff; }
        .canvas-tools { background: #f8f8f8; padding: 20px; display: flex; justify-content: space-around; border-top: 1px solid #ddd; }

        /* Chat UI */
        #chat { display: none; flex-direction: column; height: 100dvh; }
        #status-bar { background: rgba(0,0,0,0.4); padding: 10px; display: flex; justify-content: space-around; font-size: 11px; }
        .dot { height: 7px; width: 7px; border-radius: 50%; display: inline-block; margin-right: 5px; background: #555; }
        .online .dot { background: #2ecc71; box-shadow: 0 0 8px #2ecc71; }
        
        .widget-bar { background: rgba(0,0,0,0.8); border-bottom: 1px solid rgba(255,255,255,0.1); }
        .controls { display: flex; gap: 10px; padding: 12px; overflow-x: auto; scrollbar-width: none; }
        .btn-s { background: var(--glass); border: none; color: white; padding: 10px 16px; border-radius: 12px; font-size: 12px; white-space: nowrap; font-weight: 600; }
        
        #player-container { width: 100%; height: 0; transition: height 0.3s; overflow: hidden; background: #000; }

        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        .msg { padding: 12px 16px; border-radius: 18px; max-width: 80%; backdrop-filter: blur(10px); font-size: 15px; }
        .my-msg { background: var(--accent); align-self: flex-end; border-bottom-right-radius: 4px; }
        .their-msg { background: var(--glass); align-self: flex-start; border-bottom-left-radius: 4px; }
        .msg img { width: 100%; border-radius: 12px; margin-top: 8px; }
        
        .input-area { background: rgba(10,10,10,0.9); padding: 15px; padding-bottom: calc(15px + env(safe-area-inset-bottom)); display: flex; gap: 12px; align-items: center; }
        #input { flex: 1; background: rgba(255,255,255,0.1); border: none; color: white; padding: 14px 20px; border-radius: 25px; font-size: 16px; }

        /* Animation Layers */
        #animation-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1000; }
        .laser { position: absolute; height: 4px; background: linear-gradient(90deg, transparent, var(--accent), #fff); box-shadow: 0 0 15px var(--accent); animation: shoot 0.4s ease-out forwards; }
        @keyframes shoot { 0% { width: 0; transform: translateX(-100%) rotate(var(--deg)); opacity: 1; } 100% { width: 1000px; transform: translateX(100vw) rotate(var(--deg)); opacity: 0; } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }
        .star { position: absolute; animation: twinkle 2s linear forwards; }
        @keyframes twinkle { 0% { transform: scale(0); opacity: 0; } 50% { opacity: 1; } 100% { transform: translateY(-50px); opacity: 0; } }
    </style>
</head>
<body>
    <div id="animation-layer"></div>
    <audio id="buzzSound" src="https://assets.mixkit.co/active_storage/sfx/2955/2955-preview.mp3"></audio>

    <div id="setup">
        <h1 style="letter-spacing: 5px; font-weight: 200; color: var(--accent);">J & I</h1>
        <div class="setup-card">
            <select id="userSelect" class="setup-input"><option value="J">J</option><option value="I">I</option></select>
            <input type="text" id="roomInput" placeholder="Room Name" class="setup-input">
            <input type="password" id="passInput" placeholder="Password" class="setup-input">
            <button class="join-btn" onclick="join()">ENTER HUB</button>
        </div>
    </div>

    <div id="canvas-container">
        <canvas id="doodleCanvas"></canvas>
        <div class="canvas-tools">
            <button onclick="closeCanvas()" style="background:#eee; padding:15px 30px; border-radius:12px; border:none; font-weight:bold;">Cancel</button>
            <button onclick="sendDoodle()" style="background:var(--accent); color:white; padding:15px 30px; border-radius:12px; border:none; font-weight:bold;">Send</button>
        </div>
    </div>

    <div id="chat">
        <div id="status-bar">
            <div id="status-J"><span class="dot"></span> J: OFF</div>
            <div id="status-I"><span class="dot"></span> I: OFF</div>
        </div>
        <div class="widget-bar">
            <div id="player-container"><div id="yt-player" style="width:100%; height:200px;"></div></div>
            <div class="controls">
                <button class="btn-s" onclick="openCanvas()">üé® Doodle</button>
                <button class="btn-s" onclick="promptVideo()">üì∫ Youtube</button>
                <button class="btn-s" onclick="cycleTheme()">üåà Theme</button>
                <button class="btn-s" onclick="sendLocation()">üìç Dist.</button>
                <button class="btn-s" onclick="socket.emit('heart_burst', currentRoom)">üíñ</button>
                <button class="btn-s" style="background:#ff4757" onclick="socket.emit('send buzz', currentRoom)">‚ö° BUZZ</button>
            </div>
        </div>
        <ul id="messages"></ul>
        <div id="typing-indicator" style="font-size:10px; color:var(--accent); padding: 5px 20px; height:15px;"></div>
        <form id="form" class="input-area">
            <input type="file" id="fileInput" accept="image/*" style="display:none;" onchange="handleFile(this)">
            <button type="button" onclick="document.getElementById('fileInput').click()" style="background:none; border:none; font-size:24px;">üìé</button>
            <input id="input" autocomplete="off" placeholder="Message..." oninput="notifyTyping()">
            <button style="width:45px; height:45px; border-radius:50%; border:none; background:var(--accent); color:white; font-size:20px;">‚Üë</button>
        </form>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        const socket = io();
        let currentRoom = "", myLabel = "", typingTimeout, player;
        const themes = ['default', 'midnight', 'sunset', 'forest'];
        let themeIdx = 0;

        // --- DOODLE ---
        const canvas = document.getElementById('doodleCanvas');
        const ctx = canvas.getContext('2d');
        let drawing = false;

        function openCanvas() {
            document.getElementById('canvas-container').style.display = 'flex';
            canvas.width = window.innerWidth; canvas.height = window.innerHeight - 100;
            ctx.strokeStyle = "#000"; ctx.lineWidth = 5; ctx.lineCap = "round";
        }
        function closeCanvas() { document.getElementById('canvas-container').style.display = 'none'; ctx.clearRect(0,0,canvas.width,canvas.height); }
        function sendDoodle() {
            const data = canvas.toDataURL('image/png');
            socket.emit('chat message', { room: currentRoom, user: myLabel, image: data, msg: "Sent a doodle üé®" });
            closeCanvas();
        }
        canvas.addEventListener('touchstart', e => { drawing = true; const t = e.touches[0]; ctx.beginPath(); ctx.moveTo(t.clientX, t.clientY); e.preventDefault(); });
        canvas.addEventListener('touchmove', e => { if(!drawing) return; const t = e.touches[0]; ctx.lineTo(t.clientX, t.clientY); ctx.stroke(); e.preventDefault(); });
        canvas.addEventListener('touchend', () => { drawing = false; });

        // --- YOUTUBE ---
        function onYouTubeIframeAPIReady() { player = new YT.Player('yt-player', { playerVars: { 'autoplay': 1, 'playsinline': 1 } }); }
        function promptVideo() {
            const url = prompt("Paste YouTube Link:");
            if(url) {
                const match = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/);
                if (match) socket.emit('sync video', { room: currentRoom, videoId: match[2] });
            }
        }
        socket.on('sync video', data => {
            const container = document.getElementById('player-container');
            if (!data || !data.videoId) { container.style.height = "0"; player.stopVideo(); }
            else { container.style.height = "200px"; player.loadVideoById(data.videoId); }
        });

        // --- CORE UI HELPERS ---
        function addMessageToUI(data) {
            const item = document.createElement('li');
            item.className = 'msg ' + (data.user === myLabel ? 'my-msg' : 'their-msg');
            let content = `<small style="display:block; font-size:10px; opacity:0.6; margin-bottom:3px;">${data.user}</small>`;
            if(data.msg) content += `<div>${data.msg}</div>`;
            if(data.image) content += `<img src="${data.image}">`;
            item.innerHTML = content;
            document.getElementById('messages').appendChild(item);
            document.getElementById('messages').scrollTop = 99999;
        }

        // --- SOCKETS ---
        socket.on('chat message', (data) => {
            addMessageToUI(data);
            if (data.msg) {
                const t = data.msg.toLowerCase();
                if (t.includes('pew pew')) triggerLasers();
                if (t.includes('goodnight')) triggerStars();
                if (t.includes('love you')) socket.emit('heart_burst', currentRoom);
                if (t.includes('whaat') || t.includes('what')) {
                    document.getElementById('chat').style.animation = 'shake 0.4s';
                    setTimeout(() => document.getElementById('chat').style.animation = '', 400);
                }
            }
        });

        socket.on('load history', (history) => {
            document.getElementById('messages').innerHTML = '';
            history.forEach(data => addMessageToUI(data));
        });

        function join() {
            const r = document.getElementById('roomInput').value;
            const p = document.getElementById('passInput').value;
            myLabel = document.getElementById('userSelect').value;
            if (r && p) {
                currentRoom = r + "_" + p;
                document.getElementById('setup').style.display = 'none';
                document.getElementById('chat').style.display = 'flex';
                socket.emit('join room', { room: currentRoom, user: myLabel });
            }
        }

        function triggerLasers() {
            const layer = document.getElementById('animation-layer');
            for(let i=0; i<8; i++) {
                setTimeout(() => {
                    const l = document.createElement('div'); l.className = 'laser';
                    l.style.top = Math.random()*100+'vh'; l.style.setProperty('--deg', (Math.random()*30-15)+'deg');
                    layer.appendChild(l); setTimeout(()=>l.remove(), 500);
                }, i*80);
            }
        }

        function triggerStars() {
            const layer = document.getElementById('animation-layer');
            for(let i=0; i<20; i++) {
                const s = document.createElement('div'); s.className = 'star'; s.innerHTML = '‚≠ê';
                s.style.left = Math.random()*100+'vw'; s.style.top = Math.random()*100+'vh';
                layer.appendChild(s); setTimeout(()=>s.remove(), 2000);
            }
        }

        function cycleTheme() {
            themeIdx = (themeIdx + 1) % themes.length;
            socket.emit('change_theme', { room: currentRoom, theme: themes[themeIdx] });
        }
        socket.on('set_theme', (t) => document.body.className = t === 'default' ? '' : 'theme-'+t);

        socket.on('status_update', (users) => {
            ['J', 'I'].forEach(u => {
                const el = document.getElementById(`status-${u}`);
                el.className = users[u] === 'online' ? 'online' : 'offline';
                el.innerHTML = `<span class="dot"></span> ${u}: ${users[u].toUpperCase()}`;
            });
        });

        socket.on('get buzzed', () => {
            document.getElementById('buzzSound').play();
            document.getElementById('chat').style.animation = 'shake 0.5s';
            setTimeout(() => document.getElementById('chat').style.animation = '', 500);
        });

        socket.on('heart_burst', () => {
            for(let i=0; i<15; i++) {
                const h = document.createElement('div'); h.innerHTML = 'üíñ';
                h.style.position = 'fixed'; h.style.bottom = '-20px'; h.style.left = Math.random()*100+'vw';
                h.style.fontSize = '24px'; h.style.transition = 'all 2.5s ease-out';
                document.getElementById('animation-layer').appendChild(h);
                setTimeout(() => { h.style.transform = 'translateY(-110vh)'; h.style.opacity = '0'; }, 50);
                setTimeout(() => h.remove(), 2500);
            }
        });

        function sendLocation() {
            navigator.geolocation.getCurrentPosition(pos => socket.emit('send location', { room: currentRoom, user: myLabel, lat: pos.coords.latitude, lon: pos.coords.longitude }));
        }
        socket.on('receive location', data => {
            navigator.geolocation.getCurrentPosition(myPos => {
                const R = 3958.8; const dLat = (data.lat - myPos.coords.latitude) * Math.PI / 180;
                const dLon = (data.lon - myPos.coords.longitude) * Math.PI / 180;
                const a = Math.sin(dLat/2)**2 + Math.cos(myPos.coords.latitude * Math.PI / 180) * Math.cos(data.lat * Math.PI / 180) * Math.sin(dLon/2)**2;
                const d = R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                socket.emit('chat message', { room: currentRoom, user: 'System', msg: `${data.user} is ${d.toFixed(1)} miles away. üìç` });
            });
        });

        function notifyTyping() {
            socket.emit('typing', { room: currentRoom, user: myLabel, isTyping: true });
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => socket.emit('typing', { room: currentRoom, user: myLabel, isTyping: false }), 2000);
        }
        socket.on('typing', d => document.getElementById('typing-indicator').innerText = d.isTyping ? d.user + ' is typing...' : '');

        function handleFile(input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => socket.emit('chat message', { room: currentRoom, user: myLabel, image: e.target.result, msg: "" });
                reader.readAsDataURL(file);
            }
        }

        document.getElementById('form').onsubmit = (e) => {
            e.preventDefault();
            const inp = document.getElementById('input');
            if(inp.value) { socket.emit('chat message', { room: currentRoom, user: myLabel, msg: inp.value }); inp.value = ''; }
        };
    </script>
</body>
</html>
