<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>J & I Hub</title>
    <style>
        :root { --accent: #ff758c; --glass: rgba(255, 255, 255, 0.15); }
        body { font-family: -apple-system, sans-serif; background: #121212; color: white; margin: 0; height: 100dvh; overflow: hidden; }
        
        /* Setup */
        #setup { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; gap: 15px; }
        .card { background: #1e1e1e; padding: 30px; border-radius: 20px; display: flex; flex-direction: column; gap: 10px; width: 300px; }
        input, select { padding: 12px; border-radius: 10px; border: none; background: #333; color: white; }
        .btn { background: var(--accent); color: white; border: none; padding: 15px; border-radius: 10px; font-weight: bold; }

        /* Hub Layout */
        #hub { display: none; flex-direction: column; height: 100%; }
        #status-bar { background: #000; padding: 10px; display: flex; justify-content: space-around; font-size: 12px; border-bottom: 1px solid #333; }
        .dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; background: #555; margin-right: 5px; }
        .online .dot { background: #2ecc71; box-shadow: 0 0 8px #2ecc71; }

        #video-player { width: 100%; height: 0; transition: 0.3s; background: #000; overflow: hidden; }
        #messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; list-style: none; margin: 0; }
        .msg { padding: 10px 15px; border-radius: 15px; max-width: 80%; word-wrap: break-word; }
        .my-msg { background: var(--accent); align-self: flex-end; }
        .their-msg { background: #333; align-self: flex-start; }
        .msg img { width: 100%; border-radius: 10px; margin-top: 5px; }

        .input-area { background: #1e1e1e; padding: 15px; display: flex; gap: 10px; }
        #m-input { flex: 1; padding: 12px; border-radius: 20px; border: none; background: #333; color: white; }

        /* Doodle */
        #canvas-wrap { display: none; position: fixed; inset: 0; background: white; z-index: 2000; flex-direction: column; }
        canvas { flex: 1; touch-action: none; }
        
        #animation-layer { position: fixed; inset: 0; pointer-events: none; z-index: 1000; }
    </style>
</head>
<body>
    <div id="animation-layer"></div>

    <div id="setup">
        <h1 style="color:var(--accent)">J & I HUB</h1>
        <div class="card">
            <select id="userSel"><option value="J">J</option><option value="I">I</option></select>
            <input type="text" id="roomName" placeholder="Room Name">
            <button class="btn" onclick="join()">ENTER HUB</button>
        </div>
    </div>

    <div id="hub">
        <div id="status-bar">
            <div id="st-J"><span class="dot"></span> J: OFF</div>
            <div id="st-I"><span class="dot"></span> I: OFF</div>
        </div>
        
        <div id="video-player"><div id="yt-frame" style="width:100%; height:200px;"></div></div>

        <div style="padding:10px; display:flex; gap:10px; overflow-x:auto; background:#111;">
            <button onclick="openDoodle()" style="background:#333; color:white; border:none; border-radius:8px; padding:5px 15px;">üé® Doodle</button>
            <button onclick="askVideo()" style="background:#333; color:white; border:none; border-radius:8px; padding:5px 15px;">üì∫ YouTube</button>
            <button onclick="socket.emit('heart_burst', currentRoom)" style="background:#333; border:none; border-radius:8px; padding:5px 15px;">üíñ</button>
        </div>

        <ul id="messages"></ul>
        <div id="typing" style="padding-left:15px; font-size:10px; color:var(--accent); height:15px;"></div>

        <div class="input-area">
            <button onclick="document.getElementById('fileIn').click()" style="background:none; border:none; font-size:20px;">üñºÔ∏è</button>
            <input type="file" id="fileIn" style="display:none" onchange="sendFile(this)">
            <input id="m-input" placeholder="Message..." oninput="isTyping()">
            <button onclick="send()" style="background:var(--accent); border:none; color:white; padding:10px 20px; border-radius:20px;">Send</button>
        </div>
    </div>

    <div id="canvas-wrap">
        <canvas id="canv"></canvas>
        <div style="padding:20px; display:flex; justify-content:space-around; background:#eee;">
            <button onclick="closeDoodle()" style="padding:10px 30px; border-radius:10px; border:none;">Cancel</button>
            <button onclick="sendDoodle()" style="padding:10px 30px; background:var(--accent); color:white; border-radius:10px; border:none;">Send</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        const socket = io();
        let currentRoom, myUser, player;

        function join() {
            currentRoom = document.getElementById('roomName').value;
            myUser = document.getElementById('userSel').value;
            if(currentRoom) {
                document.getElementById('setup').style.display = 'none';
                document.getElementById('hub').style.display = 'flex';
                socket.emit('join room', { room: currentRoom, user: myUser });
            }
        }

        function send() {
            const val = document.getElementById('m-input').value;
            if(val) {
                socket.emit('chat message', { room: currentRoom, user: myUser, msg: val });
                document.getElementById('m-input').value = '';
            }
        }

        socket.on('chat message', data => {
            const li = document.createElement('li');
            li.className = 'msg ' + (data.user === myUser ? 'my-msg' : 'their-msg');
            li.innerHTML = `<small style="display:block;opacity:0.6">${data.user}</small>`;
            if(data.msg) li.innerHTML += `<div>${data.msg}</div>`;
            if(data.image) li.innerHTML += `<img src="${data.image}">`;
            document.getElementById('messages').appendChild(li);
            document.getElementById('messages').scrollTop = 99999;
        });

        socket.on('load history', h => h.forEach(d => socket.emit('chat message', d)));

        socket.on('status_update', users => {
            ['J', 'I'].forEach(u => {
                const el = document.getElementById('st-'+u);
                el.className = users[u] === 'online' ? 'online' : 'offline';
                el.innerHTML = `<span class="dot"></span> ${u}: ${users[u].toUpperCase()}`;
            });
        });

        // --- YouTube ---
        function onYouTubeIframeAPIReady() { player = new YT.Player('yt-frame'); }
        function askVideo() {
            const url = prompt("YouTube Link:");
            if(url) {
                const id = url.split('v=')[1]?.split('&')[0] || url.split('/').pop();
                socket.emit('sync video', { room: currentRoom, id });
            }
        }
        socket.on('sync video', d => {
            document.getElementById('video-player').style.height = '200px';
            player.loadVideoById(d.id);
        });

        // --- Doodle ---
        const canv = document.getElementById('canv');
        const ctx = canv.getContext('2d');
        let drawing = false;
        function openDoodle() { 
            document.getElementById('canvas-wrap').style.display = 'flex';
            canv.width = window.innerWidth; canv.height = window.innerHeight - 100;
            ctx.lineWidth = 5; ctx.lineCap = 'round'; ctx.strokeStyle = '#000';
        }
        function closeDoodle() { document.getElementById('canvas-wrap').style.display = 'none'; ctx.clearRect(0,0,canv.width,canv.height); }
        canv.addEventListener('touchstart', e => { drawing = true; const t = e.touches[0]; ctx.beginPath(); ctx.moveTo(t.clientX, t.clientY); });
        canv.addEventListener('touchmove', e => { if(drawing) { const t = e.touches[0]; ctx.lineTo(t.clientX, t.clientY); ctx.stroke(); } });
        canv.addEventListener('touchend', () => drawing = false);
        function sendDoodle() {
            socket.emit('chat message', { room: currentRoom, user: myUser, image: canv.toDataURL(), msg: "Sent a doodle üé®" });
            closeDoodle();
        }

        function sendFile(input) {
            const reader = new FileReader();
            reader.onload = e => socket.emit('chat message', { room: currentRoom, user: myUser, image: e.target.result });
            reader.readAsDataURL(input.files[0]);
        }

        function isTyping() { socket.emit('typing', { room: currentRoom, user: myUser, active: true }); }
        socket.on('typing', d => document.getElementById('typing').innerText = d.active ? d.user + ' is typing...' : '');
        
        socket.on('heart_burst', () => {
            for(let i=0; i<10; i++) {
                const h = document.createElement('div'); h.innerHTML = 'üíñ';
                h.style.position = 'fixed'; h.style.bottom = '0'; h.style.left = Math.random()*100+'vw';
                h.style.fontSize = '24px'; h.style.transition = '2s';
                document.getElementById('animation-layer').appendChild(h);
                setTimeout(() => { h.style.transform = 'translateY(-100vh)'; h.style.opacity = '0'; }, 50);
                setTimeout(() => h.remove(), 2000);
            }
        });
    </script>
</body>
</html>
