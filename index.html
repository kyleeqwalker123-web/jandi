<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>J & I Hub</title>
    <style>
        :root { --accent: #ff758c; --glass: rgba(255, 255, 255, 0.12); --bg-url: url('https://images.unsplash.com/photo-1464802686167-b939a67e06a1?q=80&w=2000'); }
        
        /* Theme Definitions */
        body.theme-midnight { --bg-url: url('https://images.unsplash.com/photo-1516339901600-2e1a62dc0c45?q=80&w=2000'); --accent: #7afcff; }
        body.theme-sunset { --bg-url: url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?q=80&w=2000'); --accent: #ff9e7d; }
        body.theme-forest { --bg-url: url('https://images.unsplash.com/photo-1441974231531-c6227db76b6e?q=80&w=2000'); --accent: #9dffb0; }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: #000; color: white; margin: 0; height: 100dvh; overflow: hidden;
            background-image: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), var(--bg-url);
            background-size: cover; background-position: center; transition: background 1s ease;
        }

        /* --- VERTICAL SETUP UI --- */
        #setup { 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            height: 100%; padding: 40px 20px; text-align: center;
        }
        #setup h1 { font-size: 32px; font-weight: 200; letter-spacing: 5px; margin-bottom: 30px; color: var(--accent); }
        .setup-card { 
            width: 100%; max-width: 320px; background: rgba(255,255,255,0.08); 
            backdrop-filter: blur(20px); padding: 25px; border-radius: 25px; 
            border: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; gap: 15px;
        }
        .setup-input { 
            width: 100%; padding: 15px; background: rgba(0,0,0,0.3); color: white; 
            border: 1px solid rgba(255,255,255,0.1); border-radius: 15px; font-size: 16px; 
        }
        .join-btn { 
            width: 100%; padding: 16px; background: var(--accent); color: white; 
            border: none; border-radius: 15px; font-size: 18px; font-weight: 600; margin-top: 10px;
        }

        /* --- CHAT UI --- */
        #chat { display: none; flex-direction: column; height: 100dvh; }
        #status-bar { background: rgba(0,0,0,0.4); padding: 10px 20px; display: flex; justify-content: space-around; font-size: 11px; letter-spacing: 1px; }
        .dot { height: 7px; width: 7px; border-radius: 50%; display: inline-block; margin-right: 6px; background: #555; }
        .online .dot { background: #2ecc71; box-shadow: 0 0 8px #2ecc71; }
        
        .widget-bar { background: rgba(0,0,0,0.8); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(255,255,255,0.1); }
        .controls { display: flex; gap: 10px; padding: 12px; overflow-x: auto; scrollbar-width: none; }
        .btn-s { background: var(--glass); border: none; color: white; padding: 10px 16px; border-radius: 12px; font-size: 12px; font-weight: 600; white-space: nowrap; }

        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        .msg { padding: 12px 16px; border-radius: 18px; max-width: 80%; backdrop-filter: blur(10px); line-height: 1.4; font-size: 15px; }
        .my-msg { background: var(--accent); align-self: flex-end; border-bottom-right-radius: 4px; color: white; }
        .their-msg { background: var(--glass); align-self: flex-start; border-bottom-left-radius: 4px; }
        .msg small { display: block; font-size: 10px; opacity: 0.7; margin-bottom: 4px; }

        .input-area { 
            background: rgba(10,10,10,0.9); padding: 15px; 
            padding-bottom: calc(15px + env(safe-area-inset-bottom)); 
            display: flex; gap: 12px; align-items: center; 
        }
        #input { 
            flex: 1; background: rgba(255,255,255,0.1); border: none; color: white; 
            padding: 14px 20px; border-radius: 25px; font-size: 16px; 
        }
        .circle-btn { width: 45px; height: 45px; border-radius: 50%; border: none; background: var(--accent); color: white; font-size: 20px; flex-shrink: 0; }

        #animation-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1000; }
    </style>
</head>
<body>
    <div id="animation-layer"></div>

    <div id="setup">
        <h1>J & I</h1>
        <div class="setup-card">
            <select id="userSelect" class="setup-input">
                <option value="J">I am J</option>
                <option value="I">I am I</option>
            </select>
            <input type="text" id="roomInput" placeholder="Room Name" class="setup-input">
            <input type="password" id="passInput" placeholder="Password" class="setup-input">
            <button class="join-btn" onclick="join()">Enter Hub</button>
        </div>
    </div>

    <div id="chat">
        <div id="status-bar">
            <div id="status-J"><span class="dot"></span> J: OFFLINE</div>
            <div id="status-I"><span class="dot"></span> I: OFFLINE</div>
        </div>

        <div class="widget-bar">
            <div id="player-container"><div id="yt-player" style="width:100%; height:100%;"></div></div>
            <div class="controls">
                <button class="btn-s" onclick="cycleTheme()">üé® Theme</button>
                <button class="btn-s" onclick="promptVideo()">üì∫ Youtube</button>
                <button class="btn-s" onclick="socket.emit('heart_burst', currentRoom)">üíñ Love</button>
                <button class="btn-s" onclick="sendLocation()">üìç Distance</button>
                <button class="btn-s" style="background:#ff4757" onclick="socket.emit('send buzz', currentRoom)">‚ö° BUZZ</button>
            </div>
        </div>

        <ul id="messages"></ul>
        <div id="typing-indicator" style="font-size:10px; color:var(--accent); padding: 0 20px 5px; height: 15px;"></div>

        <form id="form" class="input-area">
            <input type="file" id="fileInput" accept="image/*" style="display:none;" onchange="handleFile(this)">
            <button type="button" onclick="document.getElementById('fileInput').click()" style="background:none; border:none; font-size:24px; color:white;">üìé</button>
            <input id="input" autocomplete="off" placeholder="Message..." oninput="notifyTyping()">
            <button class="circle-btn">‚Üë</button>
        </form>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        const socket = io();
        let currentRoom = "", myLabel = "", typingTimeout;
        const themes = ['default', 'midnight', 'sunset', 'forest'];
        let currentThemeIdx = 0;

        function cycleTheme() {
            currentThemeIdx = (currentThemeIdx + 1) % themes.length;
            socket.emit('change_theme', { room: currentRoom, theme: themes[currentThemeIdx] });
        }

        socket.on('set_theme', (theme) => {
            document.body.className = theme === 'default' ? '' : 'theme-' + theme;
        });

        function join() {
            const r = document.getElementById('roomInput').value;
            const p = document.getElementById('passInput').value;
            myLabel = document.getElementById('userSelect').value;
            if (r && p) {
                currentRoom = r + "_" + p;
                document.getElementById('setup').style.display = 'none';
                document.getElementById('chat').style.display = 'flex';
                socket.emit('join room', { room: currentRoom, user: myLabel });
            }
        }

        // Handle chat messages and animations
        socket.on('chat message', (data) => {
            const item = document.createElement('li');
            item.className = 'msg ' + (data.user === myLabel ? 'my-msg' : 'their-msg');
            item.innerHTML = `<small>${data.user}</small>${data.msg || ''}`;
            if(data.image) item.innerHTML += `<img src="${data.image}" style="width:100%; border-radius:12px; margin-top:8px;">`;
            document.getElementById('messages').appendChild(item);
            document.getElementById('messages').scrollTop = 99999;

            // Trigger animations
            if (data.msg) {
                const t = data.msg.toLowerCase();
                if (t.includes('pew pew')) triggerLasers();
                if (t.includes('goodnight')) triggerStars();
                if (t.includes('love you')) socket.emit('heart_burst', currentRoom);
            }
        });

        socket.on('status_update', (users) => {
            ['J', 'I'].forEach(u => {
                const el = document.getElementById(`status-${u}`);
                el.className = users[u] === 'online' ? 'online' : 'offline';
                el.innerHTML = `<span class="dot"></span> ${u}: ${users[u].toUpperCase()}`;
            });
        });

        socket.on('heart_burst', () => {
            for(let i=0; i<15; i++) {
                const h = document.createElement('div');
                h.style.position = 'fixed'; h.style.bottom = '-50px';
                h.style.left = Math.random()*100+'vw'; h.innerHTML = 'üíñ';
                h.style.fontSize = '24px';
                h.style.transition = 'all 3s ease-out';
                document.getElementById('animation-layer').appendChild(h);
                setTimeout(() => { h.style.transform = `translateY(-110vh) scale(1.5)`; h.style.opacity = '0'; }, 50);
                setTimeout(() => h.remove(), 3000);
            }
        });

        document.getElementById('form').onsubmit = (e) => {
            e.preventDefault();
            const val = document.getElementById('input').value;
            if(val) { socket.emit('chat message', { room: currentRoom, user: myLabel, msg: val }); document.getElementById('input').value = ''; }
        };

        function notifyTyping() {
            socket.emit('typing', { room: currentRoom, user: myLabel, isTyping: true });
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => socket.emit('typing', { room: currentRoom, user: myLabel, isTyping: false }), 2000);
        }
        socket.on('typing', d => document.getElementById('typing-indicator').innerText = d.isTyping ? d.user + ' is typing...' : '');

        function triggerLasers() { /* Same laser code as before */ }
        function triggerStars() { /* Same star code as before */ }
        function promptVideo() { /* Same YouTube prompt code */ }
    </script>
</body>
</html>
