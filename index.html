<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>J & I Hub</title>
    <style>
        :root { --accent: #ff758c; --glass: rgba(255, 255, 255, 0.12); --bg-url: url('https://images.unsplash.com/photo-1464802686167-b939a67e06a1?q=80&w=2000'); }
        
        /* Themes */
        body.theme-midnight { --bg-url: url('https://images.unsplash.com/photo-1516339901600-2e1a62dc0c45?q=80&w=2000'); --accent: #7afcff; }
        body.theme-sunset { --bg-url: url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?q=80&w=2000'); --accent: #ff9e7d; }
        body.theme-forest { --bg-url: url('https://images.unsplash.com/photo-1441974231531-c6227db76b6e?q=80&w=2000'); --accent: #9dffb0; }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: -apple-system, system-ui, sans-serif; background: #000; color: white; margin: 0; 
            height: 100dvh; overflow: hidden;
            background-image: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), var(--bg-url);
            background-size: cover; background-position: center; transition: background 1s ease;
        }

        #animation-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1000; overflow: hidden; }
        #status-bar { background: rgba(0,0,0,0.6); padding: 8px 15px; display: flex; gap: 20px; font-size: 11px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; background: #555; }
        .online .dot { background: #2ecc71; box-shadow: 0 0 8px #2ecc71; }
        .offline .dot { background: #e74c3c; }

        #chat { display: none; flex-direction: column; height: 100dvh; position: relative; }
        .widget-bar { background: rgba(0,0,0,0.85); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(255,255,255,0.1); z-index: 10; }
        #player-container { width: 100%; height: 0; transition: height 0.3s; overflow: hidden; }
        
        .controls { display: flex; gap: 8px; padding: 10px; overflow-x: auto; scrollbar-width: none; }
        .btn-s { background: var(--glass); border: none; color: white; padding: 8px 12px; border-radius: 8px; font-size: 11px; font-weight: 600; white-space: nowrap; }
        
        #messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 12px 16px; border-radius: 20px; max-width: 85%; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.05); }
        .my-msg { background: rgba(255, 117, 140, 0.6); align-self: flex-end; }
        .their-msg { background: var(--glass); align-self: flex-start; }
        
        .input-area { background: rgba(10,10,10,0.95); padding: 12px 15px; padding-bottom: calc(12px + env(safe-area-inset-bottom)); display: flex; gap: 10px; align-items: center; }
        #input { flex: 1; background: var(--glass); border: none; color: white; padding: 12px 18px; border-radius: 25px; font-size: 16px; outline: none; }
        
        /* Animation Classes */
        .laser { position: absolute; height: 4px; background: linear-gradient(90deg, transparent, #0ff, #fff); box-shadow: 0 0 15px #0ff; animation: shoot 0.4s ease-out forwards; }
        @keyframes shoot { 0% { width: 0; transform: translateX(-100%) rotate(var(--deg)); opacity: 1; } 100% { width: 1000px; transform: translateX(100vw) rotate(var(--deg)); opacity: 0; } }
        .star { position: absolute; color: #fff; animation: twinkle var(--d) linear forwards; }
        @keyframes twinkle { 0% { transform: scale(0); opacity: 0; } 50% { opacity: 1; } 100% { transform: translateY(-100px) scale(1.2); opacity: 0; } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-8px); } 75% { transform: translateX(8px); } }
    </style>
</head>
<body>
    <div id="animation-layer"></div>

    <div id="setup">
        <h1 style="color:var(--accent);">J & I HUB</h1>
        <select id="userSelect" class="setup-input" style="padding:15px; margin:5px; border-radius:10px;"><option value="J">J</option><option value="I">I</option></select>
        <input type="text" id="roomInput" placeholder="Room" class="setup-input" style="padding:15px; margin:5px; border-radius:10px;">
        <input type="password" id="passInput" placeholder="Pass" class="setup-input" style="padding:15px; margin:5px; border-radius:10px;">
        <button onclick="join()" style="padding:15px; background:var(--accent); color:white; border:none; border-radius:10px; width:100px;">Enter</button>
    </div>

    <div id="chat">
        <div id="status-bar">
            <div id="status-J"><span class="dot"></span> J: Offline</div>
            <div id="status-I"><span class="dot"></span> I: Offline</div>
        </div>

        <div class="widget-bar">
            <div id="player-container"><div id="yt-player" style="width:100%; height:100%;"></div></div>
            <div class="controls">
                <button class="btn-s" onclick="promptTheme()">üé® Themes</button>
                <button class="btn-s" onclick="promptVideo()">üì∫ Youtube</button>
                <button class="btn-s" onclick="socket.emit('heart_burst', currentRoom)">üíñ Love</button>
                <button class="btn-s" onclick="sendLocation()">üìç Distance</button>
                <button class="btn-s" style="background:#ff4757" onclick="socket.emit('send buzz', currentRoom)">‚ö° BUZZ</button>
            </div>
        </div>

        <ul id="messages"></ul>
        <div id="typing-indicator" style="font-size:10px; color:var(--accent); padding-left:15px;"></div>

        <form id="form" class="input-area">
            <input type="file" id="fileInput" accept="image/*" style="display:none;" onchange="handleFile(this)">
            <button type="button" onclick="document.getElementById('fileInput').click()" style="background:none; border:none; font-size:20px; color:white;">üìé</button>
            <input id="input" autocomplete="off" placeholder="Type..." oninput="notifyTyping()">
            <button class="btn-s" style="background:var(--accent); border-radius:50%; width:40px; height:40px;">‚Üë</button>
        </form>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        const socket = io();
        let currentRoom = "", myLabel = "", typingTimeout;

        // --- THEME SYNC ---
        function promptTheme() {
            const t = prompt("Pick a theme: midnight, sunset, forest, or default");
            if (t) socket.emit('change_theme', { room: currentRoom, theme: t });
        }
        socket.on('set_theme', (theme) => {
            document.body.className = theme === 'default' ? '' : 'theme-' + theme;
        });

        // --- KEYWORD ANIMATIONS ---
        function triggerLasers() {
            for(let i=0; i<8; i++) {
                setTimeout(() => {
                    const l = document.createElement('div'); l.className = 'laser';
                    l.style.top = Math.random()*100+'vh'; l.style.setProperty('--deg', (Math.random()*20-10)+'deg');
                    document.getElementById('animation-layer').appendChild(l);
                    setTimeout(()=>l.remove(), 500);
                }, i*100);
            }
        }

        function triggerGoodnight() {
            for(let i=0; i<20; i++) {
                const s = document.createElement('div'); s.className = 'star'; s.innerHTML = '‚≠ê';
                s.style.left = Math.random()*100+'vw'; s.style.top = Math.random()*100+'vh';
                s.style.setProperty('--d', (Math.random()*2+1)+'s');
                document.getElementById('animation-layer').appendChild(s);
                setTimeout(()=>s.remove(), 3000);
            }
        }

        // --- MAIN LOGIC ---
        socket.on('chat message', (data) => {
            addMessageToUI(data);
            if (data.msg) {
                const t = data.msg.toLowerCase();
                if (t.includes('pew pew')) triggerLasers();
                if (t.includes('goodnight')) triggerGoodnight();
                if (t.includes('love you')) socket.emit('heart_burst', currentRoom);
                if (t.includes('whaat')) { document.getElementById('chat').style.animation = 'shake 0.5s'; setTimeout(()=>document.getElementById('chat').style.animation='', 500); }
            }
        });

        function join() {
            const r = document.getElementById('roomInput').value;
            myLabel = document.getElementById('userSelect').value;
            if (r) {
                currentRoom = r;
                document.getElementById('setup').style.display = 'none';
                document.getElementById('chat').style.display = 'flex';
                socket.emit('join room', { room: currentRoom, user: myLabel });
            }
        }

        function addMessageToUI(data) {
            const item = document.createElement('li');
            item.className = 'msg ' + (data.user === myLabel ? 'my-msg' : 'their-msg');
            item.innerHTML = `<small>${data.user}</small><br>${data.msg || ''}`;
            if(data.image) item.innerHTML += `<img src="${data.image}" style="width:100%; border-radius:10px; margin-top:5px;">`;
            document.getElementById('messages').appendChild(item);
            document.getElementById('messages').scrollTop = 99999;
        }

        socket.on('status_update', (users) => {
            ['J', 'I'].forEach(u => {
                const el = document.getElementById(`status-${u}`);
                el.className = users[u] === 'online' ? 'online' : 'offline';
                el.innerHTML = `<span class="dot"></span> ${u}: ${users[u]}`;
            });
        });

        socket.on('heart_burst', () => {
            for(let i=0; i<15; i++) {
                const h = document.createElement('div'); h.style.position = 'fixed'; h.style.bottom = '0';
                h.style.left = Math.random()*100+'vw'; h.innerHTML = 'üíñ';
                h.style.animation = `twinkle 3s linear forwards`;
                document.getElementById('animation-layer').appendChild(h);
                setTimeout(()=>h.remove(), 3000);
            }
        });

        document.getElementById('form').onsubmit = (e) => {
            e.preventDefault();
            const val = document.getElementById('input').value;
            if(val) { socket.emit('chat message', { room: currentRoom, user: myLabel, msg: val }); document.getElementById('input').value = ''; }
        };

        function notifyTyping() {
            socket.emit('typing', { room: currentRoom, user: myLabel, isTyping: true });
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => socket.emit('typing', { room: currentRoom, user: myLabel, isTyping: false }), 2000);
        }
        socket.on('typing', d => document.getElementById('typing-indicator').innerText = d.isTyping ? d.user + ' is typing...' : '');

    </script>
</body>
</html>
