<!DOCTYPE html>
<html>
<head>
    <title>J & I Secure Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: -apple-system, sans-serif; background: #000; color: white; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        #setup { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background: #111; padding: 20px; text-align: center; }
        #chat { display: none; flex-direction: column; height: 100vh; }
        
        .header { padding: 10px; background: #222; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; }
        .btn-small { background: #444; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 11px; }
        
        #messages { flex-grow: 1; overflow-y: auto; padding: 20px; list-style: none; display: flex; flex-direction: column; margin: 0; }
        
        .msg { margin-bottom: 12px; padding: 12px 16px; border-radius: 18px; max-width: 75%; position: relative; word-wrap: break-word; cursor: pointer; }
        .label { font-size: 0.7em; font-weight: bold; margin-bottom: 3px; display: block; opacity: 0.6; }
        
        /* J's Bubbles (Left and Blue) */
        .msg-j { background: #0056b3; align-self: flex-start; border-bottom-left-radius: 2px; }
        /* I's Bubbles (Right and Green) */
        .msg-i { background: #1e7e34; align-self: flex-end; border-bottom-right-radius: 2px; }

        .reaction-badge { position: absolute; bottom: -10px; right: 10px; background: #333; border-radius: 10px; padding: 2px 6px; font-size: 12px; border: 1px solid #555; display: none; }

        .input-area { display: flex; padding: 15px; background: #1a1a1a; border-top: 1px solid #333; }
        input, select { padding: 12px; border: none; border-radius: 8px; background: #333; color: white; margin: 6px; font-size: 16px; }
        #input { flex-grow: 1; }
        #sendBtn { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

    <div id="setup">
        <h2 style="color: #007bff;">J & I Secure Chat</h2>
        <select id="userSelect" style="width: 250px;">
            <option value="J">I am J</option>
            <option value="I">I am I</option>
        </select>
        <input type="text" id="roomInput" placeholder="Room Name">
        <input type="password" id="passInput" placeholder="Password">
        <button onclick="join()" style="background: #007bff; color: white; border: none; padding: 15px 40px; border-radius: 8px; font-weight: bold; margin-top: 10px; cursor: pointer;">Enter Chat</button>
    </div>

    <div id="chat">
        <div class="header">
            <span id="roomNameDisplay" style="font-size: 11px; opacity: 0.7;"></span>
            <button class="btn-small" style="background:#cc2525;" onclick="location.reload()">Exit & Lock</button>
        </div>
        <ul id="messages"></ul>
        <form id="form" class="input-area">
            <input id="input" autocomplete="off" placeholder="Message..." />
            <button id="sendBtn">Send</button>
        </form>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentRoom = "";
        let myLabel = "";

        function join() {
            const room = document.getElementById('roomInput').value.trim();
            const pass = document.getElementById('passInput').value.trim();
            myLabel = document.getElementById('userSelect').value;

            if (room && pass) {
                currentRoom = room + "_" + pass; 
                document.getElementById('setup').style.display = 'none';
                document.getElementById('chat').style.display = 'flex';
                document.getElementById('roomNameDisplay').innerText = "Member: " + myLabel + " | Room: " + room;
                socket.emit('join room', currentRoom);
            }
        }

        document.getElementById('form').onsubmit = (e) => {
            e.preventDefault();
            const input = document.getElementById('input');
            if (input.value.trim()) {
                const data = { 
                    id: Date.now(),
                    room: currentRoom, 
                    msg: input.value, 
                    user: myLabel, 
                    time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) 
                };
                socket.emit('chat message', data);
                input.value = '';
            }
        };

        socket.on('chat message', (data) => {
            const item = document.createElement('li');
            item.className = `msg msg-${data.user.toLowerCase()}`;
            item.id = "msg-" + data.id;
            // Click to react
            item.onclick = () => socket.emit('react', { room: currentRoom, msgId: data.id, emoji: '❤️' });
            item.innerHTML = `<span class="label">${data.user} • ${data.time}</span>${data.msg}<div class="reaction-badge"></div>`;
            document.getElementById('messages').appendChild(item);
            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
        });

        socket.on('react', (data) => {
            const msgEl = document.getElementById("msg-" + data.msgId);
            if (msgEl) {
                const badge = msgEl.querySelector('.reaction-badge');
                badge.innerText = data.emoji;
                badge.style.display = 'block';
            }
        });
    </script>
</body>
</html>
